(function(e){function i(t){return i.onprogress=t,function(){var t=e.ajaxSettings.xhr();return"function"!=typeof i.onprogress?t:(i.onprogress&&t.upload&&(t.upload.onprogress=i.onprogress),t)}}function t(t,a,d,l){var o=new FormData,s="upload_ing";o.append("file",a,a.name),o.append("action","edit_upload"),o.append("_wpnonce",mce.upload_nonce),o.append("file_type",t),d.data(s,!0),e.ajax({type:"POST",url:mce.ajax_url,data:o,processData:!1,contentType:!1,dataType:"json",error:function(e){var i="操作失败 "+e.status+" "+e.statusText+"，请刷新页面后重试";e.responseText&&e.responseText.indexOf("致命错误")>-1&&(i="网站遇到致命错误，请检查插件冲突或通过错误日志排除错误"),n("上传失败："+i,"danger"),d.data(s,!1)},xhr:i(function(e){var i=Math.round(e.loaded/e.total*100);d.parent().find(".progress-text").html('<i class="loading mr6"></i>'+(i>=100?"处理中 ...":"正在上传 "+i+"%"))}),success:function(i){if(i.msg){var t=i.ys?i.ys:i.error?"danger":"";n(i.msg,t)}e.isFunction(l)&&l(i,d),d.data(s,!1)}})}function a(){return/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)}function n(i,t,a,n){function d(e){e.addClass("notyn-out"),setTimeout(function(){e.remove()},1e3)}e(".notyn").length||e("body").append('<div class="notyn"></div>'),t=t||"success",a=a||5e3,a=a<100?1e3*a:a;var l=n?' id="'+n+'"':"",o=e('<div class="noty1"'+l+'><div class="notyf '+t+'">'+i+"</div></div>"),s=!n;n&&e("#"+n).length?(e("#"+n).find(".notyf").removeClass().addClass("notyf "+t).html(i),o=e("#"+n),s=!0):e(".notyn").append(o),s&&setTimeout(function(){d(o)},a)}var d=tinymce.PluginManager.add;d("zib_hide",function(i,t){function a(t,a){var d={payshow:"付费阅读",vip1:"会员可查看",logged:"登录后可查看",reply:"评论后查看"},l=i.selection.getNode(),o=e.trim(i.selection.getContent())||"",s="<p></p>";if(o="<p>"+o+"</p>",n(l))s="",o=e(l).find('[contenteditable="true"]').html();else if("P"===l.nodeName){var r=e.trim(l.outerHTML);r&&(i.dom.remove(l),o=r)}i.insertContent('<div class="tinymce-hide" contenteditable="false"><p class="hide-before">[hidecontent type="'+t+'" desc="隐藏内容：'+d[t]+'"]</p><div contenteditable="true">'+o+'</div><p class="hide-after">[/hidecontent]</p></div>'+s)}function n(e){return"tinymce-hide"===e.className}var d=[{text:"评论后可查看",onclick:function(){a("reply")}},{text:"登录后可查看",onclick:function(){a("logged")}},{text:"会员可查看",onclick:function(){a("vip1")}}];mce.hide_pay&&d.push({text:"付费后可查看",onclick:function(e){a("payshow",e)}}),i.addButton("zib_hide",{text:"",icon:"preview",tooltip:"隐藏内容",type:"menubutton",stateSelector:".tinymce-hide",menu:d}),i.on("wptoolbar",function(e){n(e.element)&&i.wp&&(e.toolbar=i.wp._createToolbar(["zib_hide","dom_remove"],!0))})}),d("zib_quote",function(i,t){function a(t){var a=e.trim(i.selection.getContent())||"",d="<p></p>";a="<p>"+a+"</p>";var l=i.selection.getNode();if(n(l))d="",a=e(l).find('[contenteditable="true"]').html();else if("P"===l.nodeName){var o=e.trim(l.outerHTML);o&&(i.dom.remove(l),a=o)}i.insertContent('<div class="quote_q quote-mce '+t+'" contenteditable="false"><div contenteditable="true">'+a+"</div></div>"+d)}function n(i){return e(i).hasClass("quote_q")}i.addButton("zib_quote",{text:"",icon:"blockquote",tooltip:"引言",type:"menubutton",menu:[{text:"灰色",onclick:function(){a("")}},{text:"红色",onclick:function(){a("qe_wzk_c-red")}},{text:"蓝色",onclick:function(){a("qe_wzk_lan")}},{text:"绿色",onclick:function(){a("qe_wzk_lv")}}]}),i.on("wptoolbar",function(e){n(e.element)&&i.wp&&(e.toolbar=i.wp._createToolbar(["zib_quote","dom_remove"],!0))})}),d("zib_img",function(i,n){function d(){var e,i='<div class="box-body"><p>请填写图片地址：</p><textarea id="'+p+'" rows="2" tabindex="1" class="form-control input-textarea" style="height:84px;" placeholder="http://..."></textarea></div><div class="modal-buts but-average"><a id="'+u+'" class="but c-blue" href="javascript:;">确认插入</a></div>';if(x){var t='<div class="box-body"><div class="em09 muted-2-color mb6">上传图片支持jpg、png、gif格式，最大'+_+'M</div><label class="muted-box pointer block"><input id="'+v+'" style="display: none;" class="" type="file" accept="'+c+'"><div style="padding: 40px 10px;" class="text-center opacity5 '+b+'"><i aria-hidden="true" class="fa fa-camera mr6"></i>上传图片</div></label></div>',a='<div id="'+g+'"><div class="box-body"> <div class="my-lists mini-scrollbar scroll-y max-vh5"></div></div><div class="modal-buts but-average"><a style="display: none;" class="but c-blue my-submit" href="javascript:;">确认插入</a></div></div>';e='<button data-dismiss="modal" class="mr10 mt10 close"><svg class="ic-close" aria-hidden="true"><use xlink:href="#icon-close"></use></svg></button><ul class="mt20 text-center list-inline tab-nav-theme"><li class="active ml20"><a href="#'+f+'-1" data-toggle="tab">输入地址</a></li><li><a href="#'+f+'-2" data-toggle="tab">上传图片</a></li><li><a href="#'+f+'-3" data-toggle="tab">我的图片</a></li></ul>',e+='<div class="tab-content">                <div class="tab-pane fade in active" id="'+f+'-1">'+i+'</div>                <div class="tab-pane fade" id="'+f+'-2">'+t+'</div>                <div class="tab-pane fade" id="'+f+'-3">'+a+"</div>                </div>"}else e=i;var n='<div class="modal flex jc fade" id="'+m+'" tabindex="-1" role="dialog" aria-hidden="false" style="display: none; z-index: 100101;">                            <div class="modal-mini modal-dialog" role="document">                            <div class="modal-content">'+e+"</div>                            </div></div></div>";h.append(n)}function l(){e("#"+m).modal("hide"),e("#"+p).val(""),e("#"+m+" .preview-box").remove(),e("#"+m+" ."+b).show()}function o(){e("#"+m).modal("show")}function s(i){if(!y||1!==i){var t=e("#"+g+" .my-lists"),a="",n={action:"current_user_image",paged:i||1};y||1!==i||t.html('<div class="mb6 theme-pagination" style="padding: 60px 0;"></div>'),e("#"+g+" .theme-pagination").html('<div class="muted-2-color flex jc"><div class="loading mr10"></div>正在加载</div>'),e.post(mce.ajax_url,n,function(n){e("#"+g+" .theme-pagination").remove(),n.lists&&e.each(n.lists,function(e,i){a+='<div class="myimg-list"><div class="myimg-list-box"><img data-edit-file-id="'+i.id+'" src="'+i.thumbnail_url+'" data-large-src="'+i.large_url+'" alt="'+i.title+'" data-full-url="'+i.url+'"></div></div>'}),a&&n.all_pages>i&&(a+='<div class="text-center theme-pagination"><div class="ajax-next"><a href="" next-paged="'+(i+1)+'"><i class="fa fa-angle-right"></i>加载更多</a></div></div>'),1===i?a?t.html(a):t.html('<div class="muted-2-color mb6 theme-pagination text-center" style="padding: 60px 0;">您暂无已上传的图片</div>'):t.find(".myimg-list").last().after(a)},"json")}}function r(e,i){if("undefined"==typeof FileReader)return notyf("当前浏览器不支持图片上传，请更换浏览器","danger");var t=new FileReader;t.readAsDataURL(e),t.onload=function(e){i&&i(e.target.result)}}var c="image/gif,image/jpeg,image/jpg,image/png",v="edit-zibimg-input",m="edit-zibimg-modal",p="edit-zibimg-url",u="edit-zibimg-url-btn",f="edit-zibimg-tab-",g="edit-zibimg-mybox",b="upload-placeholder",h=e("body"),x=mce.img_allow_upload,y=!1,_=mce.img_max||4;d(),e('a[href="#'+f+'-3"]').on("shown.bs.tab",function(e){y||s(1),y=!0}),e("#"+g).on("click","a[next-paged]",function(i){var t=~~e(this).attr("next-paged");return s(t),!1}),e("#"+g).on("click",".myimg-list",function(i){e(this).toggleClass("active");var t=e("#"+g+" .my-submit");e("#"+g+" .myimg-list.active").length?t.show():t.hide()}),e("#"+g).on("click",".my-submit",function(t){var a="";e("#"+g+" .myimg-list.active").each(function(){var i=e(this).removeClass("active").find("img").clone();i.attr("src",i.attr("data-large-src")),i.removeAttr("data-large-src"),a+="<p>"+i.prop("outerHTML")+"</p>"}),e(this).hide(),l(),i.insertContent(a+"<p></p>")}),e("#"+u).on("click",function(t){var a=e("#"+p).val();if(!a)return notyf("请输入图片地址","warning");i.insertContent('<img src="'+a+'"><p></p>'),l()}),e("#"+v).on("change",function(a){var n=this.files||a.dataTransfer.files,d="upload_ing",o=e(this),s=o.parent();if(!n[0]||o.data(d))return!1;var c=n[0];if(c.size>1024e3*_)return notyf("文件["+c.name+"]大小超过限制，最大"+_+"M，请重新选择","danger");r(c,function(e){var i='<div class="preview-box img-preview-box"><img class="preview-img" alt="'+c.name+'" src="'+e+'"><badge class="progress-text b-black mr6 mt6"></badge></div>';s.find("."+b).hide(),s.append(i)}),t("image",c,o,function(e){if(e.url){y=!1,l();var t=e.large_url||e.url;i.insertContent('<img data-edit-file-id="'+e.id+'" src="'+t+'" alt="'+e.title+'" data-full-url="'+e.url+'"><p></p>')}})}),i.addButton("zib_img",{text:"",icon:"image",tooltip:"图片",onclick:function(){a()||o()},onTouchEnd:function(){a()&&o()}})}),d("zib_video",function(i,n){function d(){var e="",i="",t='<div class="box-body"><p>请输入视频地址：</p><textarea id="'+m+'" rows="2" tabindex="1" class="form-control input-textarea" style="height:84px;" placeholder="http://..."></textarea></div><div class="modal-buts but-average"><a id="'+p+'" class="but c-blue" href="javascript:;">确认插入</a></div>';if(h){var a='<div class="box-body"><div class="em09 muted-2-color mb6">支持常见视频格式，最大'+_+'M</div><label class="muted-box pointer block"><input id="'+c+'" style="display: none;" class="" type="file" accept="'+r+'"><div style="padding: 40px 10px;" class="text-center opacity5 '+g+'"><i aria-hidden="true" class="fa fa-cloud-upload mr6"></i>上传视频</div></label></div>',n='<div id="'+f+'"><div class="box-body"><div class="my-lists mini-scrollbar scroll-y max-vh5"></div></div></div>';i+='<li><a href="#'+u+'-2" data-toggle="tab">上传视频</a></li><li><a href="#'+u+'-3" data-toggle="tab">我的视频</a></li>',e+='<div class="tab-pane fade" id="'+u+'-2">'+a+'</div><div class="tab-pane fade" id="'+u+'-3">'+n+"</div>"}if(x){var d='<div class="box-body"><p>请输入嵌入地址或者直接粘贴iframe嵌入代码：</p><textarea rows="2" tabindex="1" class="form-control input-textarea" style="height:84px;" placeholder="&lt;iframe src=&quot;https://....&quot;&gt;&lt;/iframe&gt;"></textarea></div><div class="modal-buts but-average"><a class="but c-blue iframe-submit" href="javascript:;">确认嵌入</a></div>';i+='<li><a href="#'+u+'-4" data-toggle="tab">嵌入视频</a></li>',e+='<div class="tab-pane fade" id="'+u+'-4">'+d+"</div>"}i?(i='<ul class="mt20 text-center list-inline tab-nav-theme"><li class="active ml20"><a href="#'+u+'-1" data-toggle="tab">输入地址</a></li>'+i+"</ul>",e='<div class="tab-content"><div class="tab-pane fade in active" id="'+u+'-1">'+t+"</div>"+e+"</div>"):e=t;var l='<div class="modal flex jc fade" id="'+v+'" tabindex="-1" role="dialog" aria-hidden="false" style="display: none; z-index: 100101;">                            <div class="modal-mini modal-dialog" role="document">                            <div class="modal-content"><button data-dismiss="modal" class="mr10 mt10 close"><svg class="ic-close" aria-hidden="true"><use xlink:href="#icon-close"></use></svg></button>'+i+e+"</div>                            </div></div></div>";b.append(l)}function l(){e("#"+v).modal("hide"),e("#"+m).val(""),e("#"+u+"-4 textarea").val(""),e("#"+v+" .preview-box").remove(),e("#"+v+" ."+g).show()}function o(){e("#"+v).modal("show")}function s(i){if(!y||1!==i){var t=e("#"+f+" .my-lists"),a="",n={action:"current_user_video",paged:i||1};y||1!==i||t.html('<div class="mb6 theme-pagination" style="padding: 60px 0;"></div>'),e("#"+f+" .theme-pagination").html('<div class="muted-2-color flex jc"><div class="loading mr10"></div>正在加载</div>'),e.post(mce.ajax_url,n,function(n){e("#"+f+" .theme-pagination").remove(),n.lists&&e.each(n.lists,function(e,i){a+='<div class="myimg-list pointer" data-video-name="'+i.filename+'" data-video-url="'+i.url+'" ><div class="myimg-list-box"><div class="px12 flex1 flex xx padding-6"><div class="px12 text-ellipsis-2"><i class="fa fa-file-video-o mr6"></i>'+i.filename+'</div><div class="flex1 flex ab muted-2-color"><span class=""><i class="fa fa-play-circle-o mr3"></i>'+i.fileLength+"</span></div></div></div></div>"}),a&&n.all_pages>i&&(a+='<div class="text-center theme-pagination"><div class="ajax-next"><a href="" next-paged="'+(i+1)+'"><i class="fa fa-angle-right"></i>加载更多</a></div></div>'),1===i?a?t.html(a):t.html('<div class="muted-2-color mb6 theme-pagination text-center" style="padding: 60px 0;">您暂无已上传的视频</div>'):t.find(".myimg-list").last().after(a)},"json")}}var r="video/*",c="edit-zibvideo-input",v="edit-zibvideo-modal",m="edit-zibvideo-url",p="edit-zibvideo-url-btn",u="edit-zibvideo-tab-",f="edit-zibvideo-mybox",g="upload-placeholder",b=e("body"),h=mce.video_allow_upload,x=mce.video_allow_iframe,y=!1,_=mce.video_max||30;d(),e('a[href="#'+u+'-3"]').on("shown.bs.tab",function(e){y||s(1),y=!0}),e("#"+f).on("click","a[next-paged]",function(i){var t=~~e(this).attr("next-paged");return s(t),!1}),e("#"+f).on("click",".myimg-list",function(t){var a=e(this).attr("data-video-url"),n=e(this).attr("data-video-name");l(),i.insertContent('<div contenteditable="false" data-video-url="'+a+'" data-video-name="'+n+'" class="new-dplayer post-dplayer dplayer"></div><p></p>')}),e("#"+u+"-4").on("click",".iframe-submit",function(t){var a=e("#"+u+"-4 textarea").val();if(!a)return notyf("请输入嵌入地址","warning");var n=e.parseHTML(a);a=e(n).attr("src")||tinymce.html.Entities.encodeAllRaw(a),l(),i.insertContent('<div contenteditable="false" class="wp-block-embed is-type-video mb20"><div class="iframe-absbox" style="padding-bottom:65%;"><iframe src="'+a+'" allowfullscreen="allowfullscreen" framespacing="0" border="0" width="100%" frameborder="no"></iframe></div></div><p></p>')}),e("#"+p).on("click",function(t){var a=e("#"+m).val();if(!a)return notyf("请输入视频地址","warning");l(),i.insertContent('<div contenteditable="false" data-video-url="'+a+'" data-video-name="'+a+'" class="new-dplayer post-dplayer dplayer"></div><p></p>')}),e("#"+c).on("change",function(a){var n=this.files||a.dataTransfer.files,d="upload_ing",o=e(this),s=o.parent();if(!n[0]||o.data(d))return!1;var r=n[0];if(r.size>1024e3*_)return notyf("文件["+r.name+"]大小超过限制，最大"+_+"M，请重新选择","danger");var c='<div class="preview-box" style="padding:15px 0;"><div class="mb30"><i class="fa fa-file-video-o mr6"></i>'+r.name+'</div><div class="progress-text opacity5"></div></div>';s.find("."+g).hide(),s.append(c),t("video",r,o,function(e){e.url&&(y=!1,l(),i.insertContent('<div contenteditable="false" data-video-url="'+e.url+'" data-video-name="'+e.filename+'" data-edit-file-id="'+e.id+'" class="new-dplayer post-dplayer dplayer"></div><p></p>'))})}),i.addButton("zib_video",{text:"",tooltip:"视频",icon:"media",onclick:function(){a()||o()},onTouchEnd:function(){a()&&o()}})})})(jQuery);