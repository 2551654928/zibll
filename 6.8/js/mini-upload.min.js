"use strict";function miniupload(){function a(a,e){if("undefined"==typeof FileReader)return notyf("当前浏览器不支持图片上传，请更换浏览器","danger");var t=new FileReader;t.readAsDataURL(a),t.onload=function(a){e&&e(a.target.result)}}function e(a){return e.onprogress=a,function(){var a=$.ajaxSettings.xhr();return"function"!=typeof e.onprogress?a:(e.onprogress&&a.upload&&(a.upload.onprogress=e.onprogress),a)}}var t,i=$("body"),n='[zibupload="image_upload"]',r='[zibupload="submit"]',o=".form-upload,.mini-upload,form",d='<div class="add"></div>',s=".add",l={};i.on("change",n,function(e){var i=$(this),n=this.files||e.dataTransfer.files,r=$(i.parents(o)[0]),p=i.attr("size_max")||Number(_win.up_max_size)||2,u=i.attr("data-preview")||".preview",c=r.find(u);t=c.html();var f=i.attr("accept"),v=i.attr("multiple"),m=i.attr("multiple_max"),h=!1;if(-1!==f.indexOf("image")&&(h="image"),-1!==f.indexOf("vedio")&&(h="vedio"),!i.attr("upload_id")){var g=parseInt((Math.random()+1)*Math.pow(10,4));i.attr("upload_id",g)}g=i.attr("upload_id");l[g]||(l[g]=[]),$.each(n,function(a,e){var t=e.name;h&&-1==e.type.indexOf(h)?(notyf("文件["+t+"]格式错误","danger"),i.val("")):p&&e.size>1024e3*p?notyf("文件["+t+"]大小超过限制，最大"+p+"M，请重新选择","danger"):c.find('[preview-name="'+t+'"]').length||l[g].push(e)});var w=[],_=1,b=!1;$.each(l[g],function(e,t){if(m&&m<_)return notyf("文件数量过多！最多可选择"+m+"个文件","danger"),!1;_++,w.push(t),a(t,function(a){var e='<img class="fit-cover" preview-name="'+t.name+'" src="'+a+'">';if(v){b||(c.html(""),b=!0);var i='<div class="preview-remove" upload-id="'+g+'" file-key="'+$.inArray(t,w)+'"><svg class="ic-close" aria-hidden="true"><use xlink:href="#icon-close"></use></svg></div>';e='<div class="preview-item">'+e+i+"</div>",c.append(e).find(s).remove(),m&&m>=_&&c.append(d)}else c.html(e)})}),l[g]=w,r.find("[auto-submit]").click()}),i.on("click",".preview-remove",function(a){var e=$(this),t=e.attr("file-key"),i=e.attr("upload-id");return e.parent().animate({width:0},200,"swing",function(){var a=$(this).parent();$(this).remove(),l[i].splice(t,1),a.find(s).length||a.append(d)}),!1}),i.on("click",".preview "+s,function(a){var e=$(this),t=$(e.parents(o)[0]);t.find(n).click()}),i.on("click",r,function(a){var i=$(this);if(i.attr("disabled"))return!1;a.preventDefault?a.preventDefault():a.returnValue=!1;var r=i.html(),d=$(i.parents(o)[0]),s=d.find(n),p=new FormData,u=d.find('[zibupload="select_but"]')||in_up.siblings(".but"),c=i.attr("zibupload-nomust");if(s.each(function(){var a=$(this),e=a.attr("upload_id");if(e&&l[e]){var t=0,i=a.attr("data-tag")||"file";$.each(l[e],function(a,e){var n=t?i+"_"+t:i;p.append(n,e,e.name),t++}),t>1&&p.append(i+"_file_count",t),c=t}}),!c)return notyf("请先选择待上传的文件！","danger");var f=d.serializeObject();$.each(f,function(a,e){p.append(a,e)}),d.find("[data-name],input").each(function(){var a=$(this),e=a.attr("name")||a.attr("data-name"),t=a.val()||a.attr("data-value");void 0===t&&(t=""),null===p.get(e)&&p.append(e,t)});var v=function(a){i.attr("disabled",!1).html(r),u.attr("disabled",!1),s.attr("disabled",!1).val("").each(function(){var a=$(this),e=a.attr("upload_id");e&&l[e]&&(l[e]=[])}),!a&&t&&d.find(".preview").html(t)},m="miniupload_ajax";notyf("正在处理请稍等...","load","",m),i.attr("disabled",!0).html('<span class="miniupload-ing"><i class="loading mr3 c-white"></i><span class="loading-text c-white">上传中<count class="px12 ml3"></count></span><div class="progress progress-striped active"><div class="progress-bar progress-bar-success" role="progressbar" style="width:0;"></div></div></span>'),s.attr("disabled",!0),u.attr("disabled",!0),$.ajax({url:_win.ajax_url,type:"POST",data:p,processData:!1,cache:!1,contentType:!1,dataType:"json",error:function(a){var e="操作失败 "+a.status+" "+a.statusText+"，请刷新页面后重试";a.responseText&&a.responseText.indexOf("致命错误")>-1&&(e="网站遇到致命错误，请检查插件冲突或通过错误日志排除错误"),notyf(e,"danger","",m),v()},xhr:e(function(a){var e=Math.round(a.loaded/a.total*100);i.find("count").html(e+"%"),e>=100&&i.find(".loading-text").html("处理中 ..."),d.find(".progress .progress-bar").css("width",e+"%")}),success:function(a){var e=a.ys?a.ys:a.error?"danger":"";notyf(a.msg||"操作成功",e,"",m),v(a.no_preview_reset),a.hide_modal&&$(i.parents(".modal")[0]).modal("hide"),a.url&&a.replace_img&&$("img"+a.replace_img).attr("src",a.url),a.reload&&(a.goto?(window.location.href=a.goto,window.location.reload):window.location.reload()),i.trigger("miniuploaded",a,d)}})})}_win.is_miniupload||(miniupload(),_win.is_miniupload=!0);